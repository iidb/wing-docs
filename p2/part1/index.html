<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Part 1 - Wing</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Part 1";
        var mkdocs_page_input_path = "p2\\part1.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Wing
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Project 1</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../p1/overview/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../p1/part1/">Part 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../p1/part2/">Part 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../p1/part3/">Part 3</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Project 2</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Part 1</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#joinplannode-and-hashjoinplannode">JoinPlanNode and HashJoinPlanNode</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#in-executionexecutorcpp">In execution/executor.cpp</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#implementing-hashjoinvecexecutor-and-joinvecexecutor">Implementing HashJoinVecExecutor and JoinVecExecutor</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#test">Test</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../part2/">Part 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../part3/">Part 3</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Wing</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Project 2</li>
      <li class="breadcrumb-item active">Part 1</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="part-1">Part 1</h1>
<p>In part 1, you will implement <code>JoinVecExecutor</code> and <code>HashJoinVecExecutor</code>. </p>
<p>To start, add two new files <code>execution/vec/hashjoin_vexecutor.hpp</code> and <code>execution/vec/join_vexecutor.hpp</code>. Make sure to include them in <code>execution/executor.cpp</code>. </p>
<h2 id="joinplannode-and-hashjoinplannode">JoinPlanNode and HashJoinPlanNode</h2>
<p>In <code>JoinPlanNode</code>, the <code>predicate_</code> member stores join predicates decomposed by <code>AND</code> (e.g., <code>select * from A, B where a.id = b.id AND a.name = b.name AND (a.age &lt; b.age or a.cost &gt; b.cost);</code> -&gt; an array of size 3 <code>{a.id = b.id, a.name = b.name, a.age &lt; b.age or a.cost &gt; b.cost}</code>), you can use <code>PredicateVec::GenExpr</code> to generate a <code>std::unique_ptr&lt;Expr&gt;</code>. The <code>output_schema_</code> member (which is inherited from its parent class) stores the output schema, <code>ch_</code> and <code>ch2_</code> stores pointers to its two children. Its <code>type_</code> is <code>PlanType::Join</code>. </p>
<p>In <code>HashJoinPlanNode</code>, the <code>predicate_</code>, <code>output_schema_</code>, <code>ch_</code>, <code>ch2_</code> members are as the same as <code>JoinPlanNode</code>. However, it has two arrays of expressions that store the hash keys. Hash keys are expressions like <code>A = B</code> where <code>A</code> only contains attributes from one side and <code>B</code> only contains attributes from the other side. These keys are used to build a hash table for the join operation. For example, in <code>select * from A, B where A.id = B.id</code>, <code>A.id</code> and <code>B.id</code> are hash keys. <code>ch_</code> is considered as the left table (build table), and <code>ch2_</code> is considered as the right table (probe table). The <code>left_hash_exprs</code> array stores <code>A.id</code> and <code>right_hash_exprs</code> array stores <code>B.id</code>. Its <code>type_</code> equals to <code>PlanType::HashJoin</code>. </p>
<p>During the optimization stage, a <code>JoinPlanNode</code> can be converted to a <code>HashJoinPlanNode</code> when it has hash keys.</p>
<h2 id="in-executionexecutorcpp">In execution/executor.cpp</h2>
<p>You need to add code to generate <code>JoinVecExecutor</code> for <code>JoinPlanNode</code> and <code>HashJoinVecExecutor</code> for <code>HashJoinPlanNode</code> in <code>InternalGenerateVec</code>. Ensure that you pass necessary parameters from plan nodes to executors. For example, in <code>ProjectPlanNode</code>, <code>project_plan-&gt;output_exprs_</code> and <code>project_plan-&gt;ch_-&gt;output_schema_</code> are passed to <code>ProjectVecExecutor</code>. </p>
<p>Since join executors have 2 child executors, you need to call <code>InternalGenerateVec</code> recursively to get the executor for <code>ch_</code> and <code>ch2_</code>. </p>
<h2 id="implementing-hashjoinvecexecutor-and-joinvecexecutor">Implementing HashJoinVecExecutor and JoinVecExecutor</h2>
<p>Create two classes that inherit from <code>VecExecutor</code>. In the constructors, pass <code>ExecOptions</code> to <code>VecExecutor</code>, which you can get using <code>db.GetOptions().exec_options</code>. Then implement <code>VecExecutor::InternalNext</code>, which should return a <code>TupleBatch</code> each time it is called. It should return an empty result if and only if there is no result to return. In addition, the size of the returned <code>TupleBatch</code> cannot exceed the maximum batch size (refer to <code>ExecOptions::max_batch_size</code> in <code>execution/execoptions.hpp</code>, it is 1024 by default). </p>
<p>For <code>JoinVecExecutor</code>, you need to implement nested loop join. For <code>HashJoinVecExecutor</code>, you need to implement hash join. You can review them in the lectures. You do not need to worry about the size of build table is larger than the memory, we assume that the memory is large enough.</p>
<p>For <code>JoinVecExecutor</code>, you need to store all the tuples from the build table. You can just use an array of <code>TupleBatch</code> to store them, or you can utilize the dynamic size mechanism of <code>TupleBatch</code>. Each time you fetch a <code>TupleBatch</code> from the probe table and you can just calculate the join predicate for each tuple from the probe table and a batch of tuples from the build table, or you can calculate the join predicate for each tuple from the build table and a batch of tuples from the probe table. You do not need to worry about the efficiency when the build table size or the probe table size is small compared to the other. For example, if the build table has only 1 tuple but the probe table has 1000 tuples, if it calculate for each tuple from the probe table, it will evaluate the predicate for 1 tuple from the build table and 1 tuple from the probe table 1000 times. We assume that the build table and the probe table are large then there is no such problem.</p>
<p>For <code>HashJoinVecExecutor</code>, you need to read all the tuples from the build table, and build a hash table. You can just use <code>std::unordered_map</code> for this purpose. For the hash function, you can use <code>utils::Hash</code> and <code>utils::Hash8</code>. <code>utils::Hash</code> can hash any data and <code>utils::Hash8</code> can only hash a 8-byte integer. For float numbers, you can just use <code>utils::Hash8</code> to hash the binary representation. Specifically, <code>TupleBatch::Get</code> returns a <code>StaticFieldRef</code>, you can use <code>StaticFieldRef::ReadInt</code> to read a 8-byte integer from the object, even if its type is float. For strings, you need to use <code>StaticFieldRef::ReadStringView()</code> to read the string view, and use <code>utils::Hash</code>. To hash more than 1 elements, you can pass the hash value as the seed parameter, for example:</p>
<pre><code class="language-c++">seed = 0x1234;
hash = utils::Hash8(114514, seed);
hash = utils::Hash8(1919810, hash);
...
</code></pre>
<p>When you fetch tuples from the child executors, you need to call <code>Next()</code> function but not <code>InternalNext()</code> function. Some statistics are maintained in <code>Next()</code> function and they will be used in Part2, Part3. There are also correctness checks in <code>Next()</code> function. Do not try to avoid them.</p>
<h2 id="test">Test</h2>
<p>You can use <code>test/test_exec --gtest_filter=ExecutorJoinTest.*</code> to test your code.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../overview/" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../part2/" class="btn btn-neutral float-right" title="Part 2">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../overview/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../part2/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
