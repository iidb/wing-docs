<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Part 1 - Wing</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Part 1";
        var mkdocs_page_input_path = "p1/part1.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Wing
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Project 1</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Part 1</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#block">Block</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#test">Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sstable">SSTable</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#filewriter">FileWriter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#filereader">FileReader</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#bloom-filter">Bloom filter</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#test_1">Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sortedrun">SortedRun</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#test_2">Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#iteratorheap">IteratorHeap</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#test_3">Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#superversion">SuperVersion</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#test_4">Test</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#smart-pointers">Smart Pointers</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../part2/">Part 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../part3/">Part 3</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Wing</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Project 1</li>
      <li class="breadcrumb-item active">Part 1</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="part-1">Part 1</h1>
<p>In part 1, you will implement </p>
<ul>
<li>
<p><code>BlockIterator</code>, <code>BlockBuilder</code>, <code>SSTable</code>, <code>SSTableIterator</code> and <code>SSTableBuilder</code>.</p>
</li>
<li>
<p><code>SortedRun</code>, <code>SortedRunIterator</code>.</p>
</li>
<li>
<p><code>IteratorHeap</code>.</p>
</li>
<li>
<p><code>SuperVersion</code>, <code>SuperVersionIterator</code> and <code>Version</code>.  </p>
</li>
</ul>
<p>Each class contains some incomplete methods. You may add fields and methods as needed, but do not remove any existing fields or remove public methods, nor change the names of the methods.</p>
<h2 id="block">Block</h2>
<p><code>Block</code> stores internal keys and values. If you do not have time to design complex formats such as a compressed format, we highly recommend you to implement the simplest format as follows:</p>
<p><img alt="" src="../lsm_pics/data_block_format.png" /></p>
<p>where the block is divided into two parts, the first part consists of key-value pairs, while the second part is an array of offsets to the key-value pairs. </p>
<p><code>BlockIterator</code> takes a pointer to the beginning of the <code>Block</code> and the <code>BlockHandle</code> of the <code>Block</code>. You can obtain useful information such as the number of key-value pairs and the size of the <code>Block</code> in <code>BlockHandle</code>. <code>BlockIterator::Seek(key, seq)</code> finds the first record larger than <code>(user_key, seq)</code> and moves to it (refer to the definition of the comparison operator in <code>storage/lsm/format.hpp</code>). <code>BlockIterator::SeekToFirst</code> moves the iterator to the beginning. You can find the comments for <code>Next()</code>, <code>key()</code>, <code>value()</code> and <code>Valid()</code> in <code>storage/lsm/iterator.hpp</code>.</p>
<p><code>BlockBuilder</code> writes key-value pairs to the block until the block reaches the capacity (refer to <code>block_size</code> in <code>storage/lsm/options.hpp</code>). You need to ensure that the size of the block do not exceed <code>block_size</code>. The offsets of key-value pairs are written after all the key-value pairs are written and <code>BlockBuilder::FinishBlock</code> is called, so you need to record the offsets while writing the data.</p>
<h3 id="test">Test</h3>
<p>You can test it through <code>test/test_lsm --gtest_filter=LSMTest.BlockTest</code></p>
<h2 id="sstable">SSTable</h2>
<p>You can implement the format as follows:</p>
<p><img alt="" src="../lsm_pics/sst_format.png" /></p>
<p>where data blocks are <code>Block</code>.</p>
<p>The index consists of the last key and the <code>BlockHandle</code> of each <code>Block</code>, as defined in <code>IndexValue</code> in <code>storage/lsm/format.hpp</code>. It is utilized to locate data block in <code>SSTable::Get</code>, <code>SSTable::Seek</code> and <code>SSTableIterator::Seek</code>. It is preloaded to the memory when opening the SSTable.</p>
<p>The bloom filter is used to test whether a key may exist in the SSTable during <code>SSTable::Get</code>. It is also preloaded to the memory.</p>
<p>You will implement <code>SSTableBuilder::Append</code> and <code>SSTableBuilder::Finish</code> while maintaining the information about the SSTable: <code>index_data_</code> (the index data), <code>index_offset_</code> (the offset of the index block), <code>largest_key_</code> and <code>smallest_key_</code> (which represent the key range of the SSTable). Once a SSTable is created, the information of the SSTable is transferred to the <code>SSTable</code> structure. You can use <code>BlockBuilder</code> to build data blocks. After writing all the key-value pairs, you can write the index data and the metadata to the file. Since we assume that we preload the index data when we open the SSTable, there is no need to use <code>Block</code> to store index data.</p>
<h3 id="filewriter">FileWriter</h3>
<p>You should use <code>FileWriter</code> to implement <code>SSTableBuilder</code>, <code>BlockBuilder</code>. It collects data and writes them to disk in batch. <code>FileWriter</code> provides two methods <code>AppendValue&lt;T&gt;</code> and <code>AppendString</code>. You can use <code>AppendValue&lt;T&gt;</code> to copy a value of type <code>T</code> to the file. <code>T</code> is a template parameter, it can be <code>uint64_t</code>, <code>float</code>, or structured data which do not have pointers, such as <code>std::pair&lt;uint64_t, uint64_t&gt;</code> and <code>BlockHandle</code>. For string data, you can use <code>AppendString</code>. Here is an example of usage:</p>
<pre><code class="language-c++">std::string str(&quot;114514&quot;);
writer.AppendValue&lt;uint64_t&gt;(str.length());
      .AppendString(str);
</code></pre>
<p>If you think the methods of <code>FileWriter</code> is difficult to use, you can modify them, but DO NOT read/write to a raw file handle in <code>SSTableBuilder</code>!</p>
<h3 id="filereader">FileReader</h3>
<p>You can use <code>FileReader</code> to read metadata and index data while initializing <code>SSTable</code>. The method <code>ReadValue</code> and <code>ReadString</code> is similar to <code>AppendValue</code> and <code>AppendString</code>. Here is an example of usage:</p>
<pre><code class="language-c++">// Read the string &quot;114514&quot;
reader.Seek(offset);
auto len = reader.ReadValue&lt;uint64_t&gt;();
auto str = reader.ReadString(len);
</code></pre>
<h3 id="bloom-filter">Bloom filter</h3>
<p>You will build a bloom filter for each SSTable. If you are not familiar with bloom filter, you can read about it in resources such as <a href="https://en.wikipedia.org/wiki/Bloom_filter">link</a>. Basically, bloom filter is a bit array. For each key, it set some bits to 1. The positions of these bits are calculated using hash functions. Then, for each key, if all the corresponding bits are 1, the key may exist, otherwise it does not. </p>
<p>We have implemented a bloom filter for you, which can be found in <code>common/bloomfilter.hpp</code> and <code>common/bloomfilter.cpp</code>. <code>BloomFilter::Create</code> create a bloom filter. <code>BloomFilter::Add</code> add a key to the bloom filter. Since we only use the hash of keys, you can pass the hash to <code>BloomFilter::Add</code>. <code>BloomFilter::Find</code> checks if a key may exist in the bloom filter. It can also accept the hash of keys.</p>
<p>In <code>SSTableBuilder</code>, you should record the hashes of keys in <code>SSTableBuilder::Append</code> and use them to build a bloom filter in <code>SSTableBuilder::Finish</code>.</p>
<h3 id="test_1">Test</h3>
<p>You can test it through <code>test/test_lsm --gtest_filter=LSMTest.SSTableTest</code></p>
<h2 id="sortedrun">SortedRun</h2>
<p><code>SortedRun</code> stores an array of SSTables. You will implement it based on <code>SSTable</code> and <code>SSTableIterator</code>.</p>
<h3 id="test_2">Test</h3>
<p>You can test it through <code>test/test_lsm --gtest_filter=LSMTest.SortedRunTest</code></p>
<h2 id="iteratorheap">IteratorHeap</h2>
<p>The <code>IteratorHeap</code> structure is used when performing merge-sort on multiple sorted runs. <code>IteratorHeap</code> takes references to the iterators, so you need to store the iterator in another area and pass the reference to it. The usage of <code>IteratorHeap</code> is as follows:</p>
<ul>
<li>
<p>First, call <code>IteratorHeap::Push</code> to pass references to the iterators to it.</p>
</li>
<li>
<p>Then, if it is necessary, call <code>IteratorHeap::Build</code> to do some preprocessing.</p>
</li>
<li>
<p>Then, you can use <code>Next</code>, <code>key</code>, <code>value</code>, <code>Valid</code> as an ordinary iterator. It returns the minimum record each time and call <code>Next</code> on the corresponding iterator.</p>
</li>
</ul>
<p>We recommend you to use a heap to maintain the minimum record. You can use <code>std::priority_queue</code> or implement your own.</p>
<p>Note that <code>IteratorHeap</code> is a template class, if you are not familiar with it, you can read about templates in resources such as <a href="https://www.runoob.com/cplusplus/cpp-templates.html">link</a>. </p>
<h3 id="test_3">Test</h3>
<p>You can test it through <code>test/test_lsm --gtest_filter=LSMTest.IteratorHeapTest</code></p>
<h2 id="superversion">SuperVersion</h2>
<p>After you implement <code>SortedRun</code>, <code>SortedRunIterator</code> and <code>IteratorHeap</code>, implementing <code>SuperVersion</code> should be straightforward. </p>
<h3 id="test_4">Test</h3>
<p>You can test it through <code>test/test_lsm --gtest_filter=LSMTest.SuperVersionTest</code></p>
<h2 id="smart-pointers">Smart Pointers</h2>
<p>We use smart pointers to manage reference counts for SSTables and sorted runs. If you are not familiar with them, you can read about smart pointers in resources such as <a href="https://learn.microsoft.com/zh-cn/cpp/cpp/smart-pointers-modern-cpp?view=msvc-170">link</a>.</p>
<p>DO NOT delete them! We rely on reference counts to support multiversion concurrency control.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../overview/" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../part2/" class="btn btn-neutral float-right" title="Part 2">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../overview/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../part2/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
